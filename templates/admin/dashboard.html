{% extends "base.html" %}

{% block title %}Admin Dashboard - School Cafeteria{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-speedometer2"></i> Admin Dashboard</h2>
        <p class="text-muted">Welcome, {{ current_user.full_name }}!</p>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card dashboard-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-1">Total Users</h6>
                        <h4 class="mb-0" id="totalUsers">-</h4>
                    </div>
                    <div class="text-primary">
                        <i class="bi bi-people fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card success dashboard-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-1">Today's Revenue</h6>
                        <h4 class="mb-0" id="todayRevenue">$0.00</h4>
                    </div>
                    <div class="text-success">
                        <i class="bi bi-cash-stack fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card warning dashboard-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-1">Pending Approvals</h6>
                        <h4 class="mb-0" id="pendingApprovals">-</h4>
                    </div>
                    <div class="text-warning">
                        <i class="bi bi-hourglass-split fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card dashboard-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-1">Meals Today</h6>
                        <h4 class="mb-0" id="mealsToday">0</h4>
                    </div>
                    <div class="text-info">
                        <i class="bi bi-utensils fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <a href="/admin/statistics" class="btn btn-outline-primary w-100">
                            <i class="bi bi-graph-up"></i> View Statistics
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/admin/purchase-approval" class="btn btn-outline-warning w-100">
                            <i class="bi bi-check2-square"></i> Approve Requests
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/admin/reports" class="btn btn-outline-success w-100">
                            <i class="bi bi-file-earmark-text"></i> Generate Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Revenue Overview</h5>
            </div>
            <div class="card-body">
                <div id="revenueLoading" class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="text-muted mt-2">Loading chart...</p>
                </div>
                <div id="revenueChart" class="d-none">
                    <canvas id="revenueCanvas" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Purchase Requests -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-cart"></i> Recent Requests</h5>
                <a href="/admin/purchase-approval" class="btn btn-sm btn-primary">View All</a>
            </div>
            <div class="card-body">
                <div id="requestsLoading" class="text-center py-4">
                    <div class="spinner-border text-primary"></div>
                </div>
                <div id="requestsContent" class="d-none">
                    <div class="list-group list-group-flush" id="requestsList"></div>
                </div>
                <div id="noRequests" class="alert alert-light text-center d-none">
                    <i class="bi bi-inbox"></i> No pending requests
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
requireRole('admin');

document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    loadRevenueChart();
    loadRecentRequests();
});

async function loadDashboardStats() {
    try {
        const response = await Auth.apiCall('/api/admin/statistics/payments');
        if (response.ok) {
            const data = await response.json();
            document.getElementById('todayRevenue').textContent = 
                '$' + (data.today_revenue || 0).toFixed(2);
        }
        
        const requestsResponse = await Auth.apiCall('/api/admin/purchase-requests');
        if (requestsResponse.ok) {
            const requestsData = await requestsResponse.json();
            const pending = requestsData.requests.filter(r => r.status === 'pending');
            document.getElementById('pendingApprovals').textContent = pending.length;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadRevenueChart() {
    const loadingEl = document.getElementById('revenueLoading');
    const chartEl = document.getElementById('revenueChart');
    
    try {
        const ctx = document.getElementById('revenueCanvas').getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Revenue ($)',
                    data: [120, 150, 180, 140, 200, 90, 0],
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value;
                            }
                        }
                    }
                }
            }
        });
        
        loadingEl.classList.add('d-none');
        chartEl.classList.remove('d-none');
    } catch (error) {
        console.error('Error loading chart:', error);
        loadingEl.innerHTML = '<p class="text-muted">Chart unavailable</p>';
    }
}

async function loadRecentRequests() {
    const loadingEl = document.getElementById('requestsLoading');
    const contentEl = document.getElementById('requestsContent');
    const noRequestsEl = document.getElementById('noRequests');
    const requestsListEl = document.getElementById('requestsList');
    
    try {
        const response = await Auth.apiCall('/api/admin/purchase-requests');
        
        if (response.ok) {
            const data = await response.json();
            const pending = data.requests.filter(r => r.status === 'pending').slice(0, 5);
            
            if (pending.length > 0) {
                requestsListEl.innerHTML = pending.map(req => `
                    <a href="/admin/purchase-approval" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Request #${req.id}</h6>
                            <small class="text-warning">${req.status}</small>
                        </div>
                        <p class="mb-1 small text-muted">By ${req.creator?.full_name || 'Unknown'}</p>
                    </a>
                `).join('');
                
                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');
            } else {
                loadingEl.classList.add('d-none');
                noRequestsEl.classList.remove('d-none');
            }
        }
    } catch (error) {
        console.error('Error loading requests:', error);
        loadingEl.classList.add('d-none');
        noRequestsEl.classList.remove('d-none');
    }
}
</script>
{% endblock %}
