{% extends "base.html" %}

{% block title %}Панель администратора - Школьная столовая{% endblock %}

{% block content %}
<!-- Welcome Header -->
<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-speedometer2 text-primary"></i> Панель администратора
            </h2>
            <p class="text-muted mb-0">Добро пожаловать, <strong>{{ current_user.full_name }}</strong>!</p>
        </div>
        <div class="mt-2 mt-sm-0">
            <span class="badge bg-light text-dark border" id="currentDate">
                <i class="bi bi-calendar3 me-1"></i> --.--.----
            </span>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card stat-card-primary">
            <div class="stat-icon">
                <i class="bi bi-people"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Всего пользователей</div>
                <div class="stat-value" id="totalUsers">-</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card stat-card-success">
            <div class="stat-icon">
                <i class="bi bi-cash-stack"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Выручка сегодня</div>
                <div class="stat-value" id="todayRevenue">0 ₽</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card stat-card-warning">
            <div class="stat-icon">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Ожидают подтверждения</div>
                <div class="stat-value" id="pendingApprovals">-</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card stat-card-info">
            <div class="stat-icon">
                <i class="bi bi-egg-fried"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Обедов сегодня</div>
                <div class="stat-value" id="mealsToday">0</div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <h5 class="section-title mb-3">Быстрые действия</h5>
        <div class="quick-actions-grid">
            <a href="/admin/statistics" class="quick-action-btn">
                <div class="quick-action-icon">
                    <i class="bi bi-graph-up"></i>
                </div>
                <div class="quick-action-label">Статистика</div>
            </a>
            <a href="/admin/purchase-approval" class="quick-action-btn">
                <div class="quick-action-icon">
                    <i class="bi bi-check2-square"></i>
                </div>
                <div class="quick-action-label">Подтвердить заказы</div>
            </a>
            <a href="/admin/reports" class="quick-action-btn">
                <div class="quick-action-icon">
                    <i class="bi bi-file-earmark-text"></i>
                </div>
                <div class="quick-action-label">Отчёты</div>
            </a>
            <a href="/notifications" class="quick-action-btn">
                <div class="quick-action-icon">
                    <i class="bi bi-bell"></i>
                </div>
                <div class="quick-action-label">Уведомления</div>
            </a>
        </div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="row g-4">
    <!-- Revenue Overview -->
    <div class="col-lg-8">
        <div class="content-card">
            <div class="content-card-header">
                <div class="d-flex align-items-center">
                    <div class="header-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <h5 class="mb-0">Обзор выручки</h5>
                </div>
            </div>
            <div class="content-card-body">
                <div id="revenueLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="text-muted mt-2 mb-0">Загрузка графика...</p>
                </div>
                <div id="revenueChart" class="d-none">
                    <canvas id="revenueCanvas" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Purchase Requests -->
    <div class="col-lg-4">
        <div class="content-card">
            <div class="content-card-header">
                <div class="d-flex align-items-center">
                    <div class="header-icon header-icon-warning">
                        <i class="bi bi-cart"></i>
                    </div>
                    <h5 class="mb-0">Недавние заказы</h5>
                </div>
                <a href="/admin/purchase-approval" class="btn btn-primary btn-sm">
                    Все заказы <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="content-card-body p-0">
                <div id="requestsLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                </div>
                <div id="requestsContent" class="d-none">
                    <ul class="activity-list" id="requestsList"></ul>
                </div>
                <div id="noRequests" class="empty-state d-none">
                    <div class="empty-state-icon">
                        <i class="bi bi-inbox"></i>
                    </div>
                    <p class="empty-state-text">Нет ожидающих заказов</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
requireRole('admin');

document.addEventListener('DOMContentLoaded', function() {
    // Set current date
    const now = new Date();
    const dateStr = now.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
    document.getElementById('currentDate').innerHTML = `<i class="bi bi-calendar3 me-1"></i> ${dateStr}`;
    
    loadDashboardStats();
    loadRevenueChart();
    loadRecentRequests();
});

async function loadDashboardStats() {
    try {
        // Load users count and meals today from dashboard endpoint
        const dashResponse = await Auth.apiCall('/api/admin/statistics/dashboard');
        if (dashResponse.ok) {
            const dashData = await dashResponse.json();
            document.getElementById('totalUsers').textContent = (dashData.users?.total_students || 0) + (dashData.users?.total_cooks || 0);
            document.getElementById('mealsToday').textContent = dashData.today?.meals_served || 0;
        }

        // Load today's revenue from payments endpoint
        const paymentsResponse = await Auth.apiCall('/api/admin/statistics/payments?days=1');
        if (paymentsResponse.ok) {
            const paymentsData = await paymentsResponse.json();
            // Get today's revenue from daily_revenue array (first element is today)
            const todayRevenue = paymentsData.daily_revenue && paymentsData.daily_revenue.length > 0
                ? paymentsData.daily_revenue[0].revenue
                : 0;
            document.getElementById('todayRevenue').textContent =
                todayRevenue.toFixed(2) + ' ₽';
        }

        // Load pending approvals from purchase requests endpoint
        const requestsResponse = await Auth.apiCall('/api/admin/purchase-requests?status=pending');
        if (requestsResponse.ok) {
            const requestsData = await requestsResponse.json();
            document.getElementById('pendingApprovals').textContent =
                requestsData.purchase_requests?.length || 0;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadRevenueChart() {
    const loadingEl = document.getElementById('revenueLoading');
    const chartEl = document.getElementById('revenueChart');
    
    try {
        // Fetch real revenue data for the last 7 days
        const response = await Auth.apiCall('/api/admin/statistics/payments?days=7');
        
        if (!response.ok) throw new Error('Failed to fetch revenue data');
        
        const data = await response.json();
        const dailyRevenue = data.daily_revenue || [];
        
        const ctx = document.getElementById('revenueCanvas').getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dailyRevenue.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                }),
                datasets: [{
                    label: 'Выручка (₽)',
                    data: dailyRevenue.map(d => d.revenue),
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' ₽';
                            }
                        }
                    }
                }
            }
        });
        
        loadingEl.classList.add('d-none');
        chartEl.classList.remove('d-none');
    } catch (error) {
        console.error('Error loading chart:', error);
        loadingEl.innerHTML = '<p class="text-muted">График недоступен</p>';
    }
}

async function loadRecentRequests() {
    const loadingEl = document.getElementById('requestsLoading');
    const contentEl = document.getElementById('requestsContent');
    const noRequestsEl = document.getElementById('noRequests');
    const requestsListEl = document.getElementById('requestsList');
    
    try {
        const response = await Auth.apiCall('/api/admin/purchase-requests?status=pending');
        
        if (response.ok) {
            const data = await response.json();
            const pending = (data.purchase_requests || []).slice(0, 5);
            
            if (pending.length > 0) {
                requestsListEl.innerHTML = pending.map(req => {
                    const createdDate = new Date(req.created_at);
                    const formattedDate = createdDate.toLocaleDateString('ru-RU', { 
                        day: '2-digit', 
                        month: '2-digit' 
                    });
                    
                    return `
                        <li class="activity-item">
                            <div class="activity-icon warning">
                                <i class="bi bi-cart"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">Заказ #${req.id}</div>
                                <div class="activity-time">От ${req.creator_name || 'Неизвестно'} • ${formattedDate}</div>
                            </div>
                        </li>
                    `;
                }).join('');
                
                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');
            } else {
                loadingEl.classList.add('d-none');
                noRequestsEl.classList.remove('d-none');
            }
        }
    } catch (error) {
        console.error('Error loading requests:', error);
        loadingEl.classList.add('d-none');
        noRequestsEl.classList.remove('d-none');
    }
}
</script>
{% endblock %}
